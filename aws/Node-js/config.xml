<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@1559.va_a_533730b_ea_d">
  <actions>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobAction plugin="pipeline-model-definition@2.2277.v00573e73ddf1"/>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction plugin="pipeline-model-definition@2.2277.v00573e73ddf1">
      <jobProperties/>
      <triggers/>
      <parameters/>
      <options/>
    </org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction>
  </actions>
  <description></description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <jenkins.model.BuildDiscarderProperty>
      <strategy class="hudson.tasks.LogRotator">
        <daysToKeep>2</daysToKeep>
        <numToKeep>2</numToKeep>
        <artifactDaysToKeep>-1</artifactDaysToKeep>
        <artifactNumToKeep>-1</artifactNumToKeep>
        <removeLastBuild>false</removeLastBuild>
      </strategy>
    </jenkins.model.BuildDiscarderProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@4238.va_6fb_65c1f699">
    <script>pipeline {
    agent any

    environment {
        // ---------------- Docker ----------------
        DOCKER_CREDENTIALS_ID = &apos;docker-cred&apos;   // username + password/token
        DOCKER_REGISTRY      = &apos;charansait372&apos;
        IMAGE_TAG            = &apos;v1.2&apos;

        IMAGE_NAME_A = &quot;${DOCKER_REGISTRY}/observability-service-a:${IMAGE_TAG}&quot;
        IMAGE_NAME_B = &quot;${DOCKER_REGISTRY}/observability-service-b:${IMAGE_TAG}&quot;

        // ---------------- Sonar -----------------
        SCANNER_HOME = tool &apos;sonar-scanner&apos;
    }

    stages {

        /* ==================================================== */
        stage(&apos;Clone Repository&apos;) {
            steps {
                git branch: &apos;main&apos;,
                    url: &apos;https://github.com/CharanSai8127/observability-zero-to-hero.git&apos;
            }
        }

        /* ==================================================== */
        stage(&apos;Run Node.js Tests&apos;) {
            steps {
                script {
                    dir(&apos;day-4/application/service-a&apos;) {
                        sh &apos;&apos;&apos;
                          npm install
                          npm test || true
                          npm audit || true
                        &apos;&apos;&apos;
                    }

                    dir(&apos;day-4/application/service-b&apos;) {
                        sh &apos;&apos;&apos;
                          npm install
                          npm test || true
                          npm audit || true
                        &apos;&apos;&apos;
                    }
                }
            }
        }

        /* ==================================================== */
        stage(&apos;Build Docker Images&apos;) {
            steps {
                script {
                    dir(&apos;day-4/application/service-a&apos;) {
                        sh &quot;docker build -t ${IMAGE_NAME_A} .&quot;
                    }

                    dir(&apos;day-4/application/service-b&apos;) {
                        sh &quot;docker build -t ${IMAGE_NAME_B} .&quot;
                    }
                }
            }
        }

        /* ==================================================== */
        stage(&apos;Trivy Image Scan (Reports)&apos;) {
            steps {
                script {
                    sh &apos;&apos;&apos;
                      mkdir -p reports/service-a reports/service-b

                      trivy image --severity HIGH,CRITICAL \
                        --format json \
                        --output reports/service-a/trivy.json \
                        ${IMAGE_NAME_A} || true

                      trivy image --severity HIGH,CRITICAL \
                        --format json \
                        --output reports/service-b/trivy.json \
                        ${IMAGE_NAME_B} || true
                    &apos;&apos;&apos;
                }
            }
        }

        /* ==================================================== */
        stage(&apos;SonarQube Analysis&apos;) {
            steps {
                withSonarQubeEnv(&apos;sonar&apos;) {
                    script {

                        dir(&apos;day-4/application/service-a&apos;) {
                            sh &apos;&apos;&apos;
                              $SCANNER_HOME/bin/sonar-scanner \
                                -Dsonar.projectKey=observability-service-a \
                                -Dsonar.sources=.
                              mkdir -p ../../../reports/service-a/sonar
                              cp .scannerwork/report-task.txt ../../../reports/service-a/sonar/ || true
                            &apos;&apos;&apos;
                        }

                        dir(&apos;day-4/application/service-b&apos;) {
                            sh &apos;&apos;&apos;
                              $SCANNER_HOME/bin/sonar-scanner \
                                -Dsonar.projectKey=observability-service-b \
                                -Dsonar.sources=.
                              mkdir -p ../../../reports/service-b/sonar
                              cp .scannerwork/report-task.txt ../../../reports/service-b/sonar/ || true
                            &apos;&apos;&apos;
                        }
                    }
                }
            }
        }

        /* ==================================================== */
        stage(&apos;SonarQube Quality Gate&apos;) {
            steps {
                timeout(time: 2, unit: &apos;MINUTES&apos;) {
                    waitForQualityGate abortPipeline: false
                }
            }
        }

        /* ==================================================== */
        stage(&apos;OWASP Dependency Check&apos;) {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: &apos;owasp-cred&apos;,
                        usernameVariable: &apos;OSSINDEX_USER&apos;,
                        passwordVariable: &apos;OSSINDEX_TOKEN&apos;
                    )
                ]) {
                    script {

                        dir(&apos;day-4/application/service-a&apos;) {
                            dependencyCheck(
                                additionalArguments: &apos;--scan .&apos;,
                                odcInstallation: &apos;owasp&apos;
                            )
                        }

                        dir(&apos;day-4/application/service-b&apos;) {
                            dependencyCheck(
                                additionalArguments: &apos;--scan .&apos;,
                                odcInstallation: &apos;owasp&apos;
                            )
                        }

                        dependencyCheckPublisher(
                            pattern: &apos;**/dependency-check-report.xml&apos;
                        )
                    }
                }
            }
        }

        /* ==================================================== */
        stage(&apos;Push Docker Images&apos;) {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: DOCKER_CREDENTIALS_ID,
                        usernameVariable: &apos;DOCKER_USER&apos;,
                        passwordVariable: &apos;DOCKER_PASS&apos;
                    )
                ]) {
                    sh &apos;&apos;&apos;
                      echo &quot;$DOCKER_PASS&quot; | docker login -u &quot;$DOCKER_USER&quot; --password-stdin
                      docker push ${IMAGE_NAME_A}
                      docker push ${IMAGE_NAME_B}
                      docker logout
                    &apos;&apos;&apos;
                }
            }
        }
    }

    /* ======================================================== */
    post {
        success {
            archiveArtifacts artifacts: &apos;reports/**&apos;, fingerprint: true
            echo &apos;CI completed successfully. All Sonar, Trivy, and OWASP reports archived.&apos;
        }

        failure {
            echo &apos;CI failed. Review logs and archived artifacts.&apos;
        }
    }
}
</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>